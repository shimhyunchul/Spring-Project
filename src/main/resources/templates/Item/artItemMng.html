<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<!-- 사용자 스크립트 추가 -->

<head>
  <link th:href="@{/css/artItemMng.css}" rel="stylesheet">
</head>

<th:block layout:fragment="script">
  <script>

    // 글로벌 스코프에 openChatPopup 함수 등록
window.openChatPopup = function() {
    const userInfo = document.querySelector('.user-info');
    if (userInfo) {
        const userId = userInfo.getAttribute('data-user-id');
        if (userId) {
            window.open('/chat/popup/' + userId, 'chatPopup', 'width=400,height=600');
        } else {
            alert('사용자 ID를 찾을 수 없습니다.');
        }
    } else {
        alert('로그인된 사용자가 없습니다.');
    }
};



$(document).ready(function(){
  console.log("Page-specific script is running.");

  $("#searchBtn").on("click", function(e) {
      e.preventDefault(); // 검색 버튼 클릭 시 form 태그 전송 막기
      page(0); // 첫 번째 페이지로 이동
  });
});

function page(page) {
const searchSellStatus = document.querySelector("#searchSellStatus").value;
const searchBy = document.querySelector("#searchBy").value;
const searchQuery = document.querySelector("#searchQuery").value;

location.href = `/admin/artItems/${page}?searchSellStatus=${searchSellStatus}&searchBy=${searchBy}&searchQuery=${searchQuery}`;
}

function filterByStatus(status) {
const searchBy = document.querySelector("select[name='searchBy']").value;
const searchQuery = document.querySelector("input[name='searchQuery']").value;

window.location.href = `/admin/artItems?searchSellStatus=${status}&searchBy=${searchBy}&searchQuery=${searchQuery}`;
}
  </script>
</th:block>


<div layout:fragment="content">

  <!-- 판매 상태 필터 -->
  <div class="row row-cols-lg-auto g-3 align-items-center">
    <button class="btn btn-secondary" onclick="filterByStatus('ALL')">전체</button>
    <button class="btn btn-success" onclick="filterByStatus('SELL')">판매중</button>
    <button class="btn btn-danger" onclick="filterByStatus('SOLD_OUT')">품절</button>
  </div>

  <!-- 상품 테이블 -->
  <form th:action="@{'/admin/artItems/'+${items.number}}" role="form" method="get" th:object="${items}">
    <table class="table">
      <thead>
      <tr>
        <td>상품아이디</td>
        <td>작품 이름</td>
        <td>상태</td>
        <td>작가 이름</td>
        <td>이미지</td>
        <td>시작 가격</td>
      </tr>
      </thead>
      <tbody id="itemTableBody">
      <tr th:each="item : ${items.getContent()}" data-status="${item.itemSellStatus}">
        <td th:text="${item.id}"></td>
        <td>
          <a th:href="'/admin/artItemForm/'+${item.id}" th:text="${item.artName}"></a>
        </td>
        <td th:text="${item.itemSellStatus == T(com.shop.constant.ItemSellStatus).SELL} ? '판매중' : '품절'"></td>
        <td th:text="${item.artistName}"></td>
        <td>

          <!-- item.imgUrl이 null이 아니거나 비어 있지 않을 때 -->
          <img th:if="${not #strings.isEmpty(item.imgUrl)}"
               th:src="${item.imgUrl}"
               alt="대표 이미지"
               style="width: 50px; height: auto;">

          <!-- item.imgUrl이 null이거나 비어 있을 때, itemImagesMap에서 첫 번째 이미지를 사용 -->
          <img th:unless="${not #strings.isEmpty(item.imgUrl)}"
               th:src="${itemImagesMap[item.id]?.get(0)?.imgUrl}"
               alt="대체 이미지"
               style="width: 50px; height: auto;">

        </td>
        <td th:text="${item.startPrice}"></td>
      </tr>
      </tbody>
    </table>

    <!-- 페이지네이션 -->
    <div th:with="start=${(items.number/maxPage)*maxPage + 1},
    end=(${(items.totalPages == 0) ?
    1 : (start + (maxPage-1) < items.totalPages ? start + (maxPage - 1) : items.totalPages)})">
      <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${items.first}?'disabled'">
          <a th:onclick="'javascript:page('+(${items.number - 1})+')'" class="page-link" aria-label="Previous">
            <span aria-hidden="true">Previous</span>
          </a>
        </li>

        <li class="page-item" th:each="page: ${#numbers.sequence(start, end)}"
            th:classappend="${items.number eq page - 1}?'active':''">
          <a th:onclick="'javascript:page(' + (${page - 1}) + ')'" class="page-link" th:text="${page}"></a>
        </li>

        <li class="page-item" th:classappend="${items.last}?'disabled'">
          <a th:onclick="'javascript:page('+(${items.number + 1})+')'" class="page-link" aria-label="Next">
            <span aria-hidden="true">Next</span>
          </a>
        </li>
      </ul>
    </div>

      <!-- 검색 필터 -->
    <div class="row row-cols-lg-auto g-3 align-items-center">
      <form th:action="@{'/admin/artItems/0'}" method="get" class="d-flex align-items-center">
        <select id="searchBy" name="searchBy" class="form-control" style="width:120px; margin-right: 10px;"
                th:value="${itemSearchDto.searchBy}">
          <option value="artistName" th:selected="${itemSearchDto.searchBy == 'artistName'}">작가 이름</option>
          <option value="artName" th:selected="${itemSearchDto.searchBy == 'artName'}">작품 이름</option>
        </select>
        <input id="searchQuery" name="searchQuery" type="text" class="form-control" style="width:200px; margin-right: 10px;"
               placeholder="검색어 입력" th:value="${itemSearchDto.searchQuery}">
        <input type="hidden" id="searchSellStatus" name="searchSellStatus" th:value="${itemSearchDto.searchSellStatus}">
        <button type="submit" class="btn btn-primary" style="width:100px;">검색</button>
      </form>
    </div>



  </form>
</div>
</html>
