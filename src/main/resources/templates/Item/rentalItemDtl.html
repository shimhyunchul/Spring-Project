<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link th:href="@{/css/rentalItemDtl.css}" rel="stylesheet">
</head>

<th:block layout:fragment="script">
  <script th:inline="javascript">

    //-------------- 채팅 연결 스크립트 ----------------------
            $(document).ready(function () {
          const csrfToken = $('meta[name="_csrf"]').attr('content');
          const csrfHeader = $('meta[name="_csrf_header"]').attr('content');
          const chatLogs = $('#chatLogs');
          const chatForm = $('#chatForm');
          const userId = $('div.user-info').data('user-id');

          const pageSize = 20; // 한 번에 가져올 데이터 개수

          // 초기 로딩 시 스크롤을 맨 아래로 이동
          function scrollToBottom() {
              chatLogs.scrollTop(chatLogs[0].scrollHeight);
          }

          // 채팅 로그 전체 새로고침
          function refreshChatLogs() {
              $.ajax({
                  url: `/chat/popup/${userId}`,
                  type: "GET",
                  data: { size: pageSize },
                  beforeSend: function (xhr) {
                      xhr.setRequestHeader(csrfHeader, csrfToken);
                  },
                  success: function (data) {
                      chatLogs.find('ul').empty(); // 기존 로그 초기화
                      if (data.chatLogs && data.chatLogs.length > 0) {
                          data.chatLogs.forEach(function (message) {
                              const newMessage = `<li>${message.senderId}: ${message.message}</li>`;
                              chatLogs.find('ul').append(newMessage); // 전체 로그 추가
                          });
                          scrollToBottom(); // 하단으로 스크롤 이동
                      } else {
                          chatLogs.find('ul').html('<li>채팅 로그가 없습니다.</li>'); // 로그 없음 표시
                      }
                  },
                  error: function (jqXHR) {
                      console.error("채팅 로그 새로고침 실패:", jqXHR.responseText);
                  },
              });
          }

          // 메시지 전송
          chatForm.on('submit', function (e) {
              e.preventDefault();
              const formData = $(this).serialize();

              $.ajax({
                  url: `/chat/popup/${userId}`,
                  type: "POST",
                  contentType: "application/x-www-form-urlencoded",
                  data: formData,
                  beforeSend: function (xhr) {
                      xhr.setRequestHeader(csrfHeader, csrfToken);
                  },
                  success: function (data) {
                      refreshChatLogs(); // 메시지 전송 후 전체 새로고침
                      chatForm[0].reset();
                  },
                  error: function (jqXHR) {
                      console.error("메시지 전송 실패:", jqXHR.responseText);
                  },
              });
          });

          // 실시간 갱신: 3초마다 전체 로그 새로고침
          setInterval(refreshChatLogs, 3000);

          // 초기화
          scrollToBottom();
          refreshChatLogs(); // 페이지 로드 시 전체 로그 불러오기
      });


      //----------------------------------------------------



window.addEventListener("pageshow", function (event) {
if (event.persisted) {
// 페이지가 캐시에서 복원되었을 때 새로고침
window.location.reload();
}
});

document.addEventListener("DOMContentLoaded", function() {
const openRentPopupButton = document.getElementById("openRentPopup");

if (openRentPopupButton) {
  openRentPopupButton.addEventListener("click", function(event) {
      const isLoggedIn = this.dataset.loggedin === "true"; // 로그인 여부
      const cash = parseFloat(this.dataset.cash); // 사용자 캐시 금액
      const price = parseFloat(this.dataset.price); // 상품 가격

      if (!isLoggedIn) {
          // 로그인하지 않은 경우
          alert("로그인이 필요합니다.");
          event.preventDefault(); // 기본 동작 방지
          return;
      }

      if (cash < price) {
          // 캐시 부족한 경우
          alert("잔액이 부족합니다. 충전 후 이용해주세요.");
          event.preventDefault(); // 기본 동작 방지
          return;
      }

      // 조건 충족 시 팝업 열기
      const overlay = document.getElementById("overlay");
      const rentPopup = document.getElementById("rentPopup");

      if (overlay && rentPopup) {
          overlay.style.display = "block";
          rentPopup.style.display = "block";
      }
  });
}

const closeRentPopupButton = document.getElementById("closeRentPopup");
if (closeRentPopupButton) {
  closeRentPopupButton.addEventListener("click", function() {
      const overlay = document.getElementById("overlay");
      const rentPopup = document.getElementById("rentPopup");

      if (overlay && rentPopup) {
          overlay.style.display = "none";
          rentPopup.style.display = "none";
      }
  });
}

const overlay = document.getElementById("overlay");
if (overlay) {
  overlay.addEventListener("click", function() {
      const rentPopup = document.getElementById("rentPopup");
      if (rentPopup) {
          overlay.style.display = "none";
          rentPopup.style.display = "none";
      }
  });
}
});

  </script>
</th:block>

<div layout:fragment="content" style="margin-left:25%;margin-right:25%">
  <input type="hidden" id="itemId" th:value="${item.id}">

  <div class="d-flex">

    <div class="repImgDiv">

      <!-- item.imgUrl이 null이 아니면 해당 이미지를 사용 -->
      <img th:if="${not #strings.isEmpty(item.imgUrl)}"
           th:src="${item.imgUrl}"
           class="rounded repImg"
           th:alt="${item.artName}">

      <!-- item.imgUrl이 null이거나 비어 있으면 itemImgs의 첫 번째 이미지를 사용 -->
      <img th:unless="${not #strings.isEmpty(item.imgUrl)}"
           th:src="${itemImgs[0]?.imgUrl}"
           class="rounded repImg">

    </div>

    <div class="right-section">

            <span th:if="${item.itemSellStatus == T(com.shop.constant.ItemSellStatus).SELL}"
                  class="badge bg-primary mgb-15">렌탈 가능</span>
      <span th:unless="${item.itemSellStatus == T(com.shop.constant.ItemSellStatus).SELL}"
            class="badge bg-primary mgb-15">렌탈중</span>
      <div class="h4" th:text="${item.artName}"></div>

      <hr class="my-4">

      <div class="text-right mgt-50">

        <div class="price">
        <h6>작가명</h6>
        <h3 name="artistName" id="artistName" class="font-weight-bold"></h3>
        <p class="name" th:text="${item.artistName}"></p>
        </div>

        <div class="price">
          <h6>렌탈 가격</h6>
        <h3 name="priceRange" id="priceRange" class="font-weight-bold"></h3>
        <p class="range" th:text="${item.price}">원</p>
      </div>

      </div>
      <!-- SELL 상태인 경우 -->
      <div th:if="${item.itemSellStatus == T(com.shop.constant.ItemSellStatus).SELL}">
        <button
                id="openRentPopup"
                type="button"
                class="btn btn-light "
                th:if="${cashSummary != null && cashSummary >= item.price}"
                th:data-loggedin="${cashSummary != null && cashSummary > 0}"
                th:data-cash="${cashSummary}"
                th:data-price="${item.price}">
          렌탈하기
        </button>

        <!-- 금액 부족 메시지 -->
        <p th:if="${cashSummary != null && cashSummary < item.price && memberCash != null
        && item.itemSellStatus == T(com.shop.constant.ItemSellStatus).SELL}" style="color: red;">
          <button class="btn btn-light" ><a href="/cash-summary/balance">잔액이 부족합니다. 충전 후 이용해주세요.</a></button>
        </p>

        <!-- 로그인 필요 메시지 -->
        <p th:if="${member == null}" style="color: red;">
          <button class="btn btn-light"><a href="/members/login">로그인이 필요합니다.</a></button>
        </p>

      </div>
      <div th:unless="${item.itemSellStatus == T(com.shop.constant.ItemSellStatus).SELL}"
           class="text-right">
        <button type="button" class="btn btn-danger btn-lg">렌탈중</button>
      </div>
    </div>
  </div>

  <div class="mgt-30">
    <div >
      <hr>
      <h4 class="writer" >상품 상세 설명</h4>
    </div>
  </div>


  <div class="writerDesc">
    <div >
      <h5><strong>작품 설명</strong></h5>
      <div class="lead" th:text="${item.writerDesc}" style="white-space: pre-wrap;"></div>
      <br>
    </div>
  </div>


  <div>
    <img th:if="${not #strings.isEmpty(item.imgUrl)}" th:src="${item.imgUrl}"
         class="rounded mgb-15"
         width="600">
  </div>


  <div>
    <div th:each="ItemImg : ${itemImgs}" class="text-center">
      <img th:if="${not #strings.isEmpty(ItemImg.imgUrl)}" th:src="${ItemImg.imgUrl}"
           class="rounded mgb-15"
           width="800">
    </div>
  </div>


  <div id="overlay"></div>



  <!-- 경매 응찰 팝업 -->
  <div id="rentPopup" style="display: none;">
    <h3>렌탈하기</h3>
    <form th:action="@{/rental/rent}" method="post">
      <input type="hidden" name="itemId" th:value="${item.id}">
      <div>
        <label th:for="rentPrice">렌탈 금액</label>
        <p class="price">KRW - [[${item.Price}]] </p>
      </div>
      <button type="submit" class="btn btn-primary">구매하기</button>
      <button id="closeRentPopup" type="button" class="btn btn-secondary">취소</button>
    </form>
  </div>



  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</div>
</html>