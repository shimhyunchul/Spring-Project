<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
  <link th:href="@{/css/myPage.css}" rel="stylesheet">
</head>

<th:block layout:fragment="script">
  <script th:inline="javascript">


    //-------------- 채팅 연결 차단 스크립트 ----------------------

    document.addEventListener("DOMContentLoaded", function () {
      const currentUrl = window.location.pathname; // 현재 URL 경로

      // 제외할 경로 패턴
      const excludedPatterns = [
        "/myRent",
        "/api/refund",
        "/cash-summary/balance",
        "/myInfo/update/",
        "/bid/my-bids/",
        "/bid/success/",
        "/cash-summary/balance"
      ];

      // 경로가 제외 목록의 패턴으로 시작하면 숨기기
      if (excludedPatterns.some(pattern => currentUrl.startsWith(pattern))) {
        const chatContainer = document.getElementById("chat-container");
        if (chatContainer) {
          chatContainer.style.display = "none"; // 숨기기
        }
      }
    });

    //----------------------------------------------------




    $(document).ready(function() {
      // CSRF 토큰을 메타 태그에서 읽어오기
      var token = $("meta[name='_csrf']").attr("content");
      var header = $("meta[name='_csrf_header']").attr("content");

      // '구매 확정' 버튼 클릭 시 AJAX 요청을 보내는 함수
      $(".confirm-purchase-btn").on("click", function(e) {
        e.preventDefault(); // 기본 동작을 방지 (예: 폼 제출)

        // 버튼에 연결된 memberId와 bidId 가져오기
        var memberId = parseInt(this.dataset.memberId, 10);
        var bidId = parseInt(this.dataset.bidId, 10);
        var purchaseConfirmed = this.dataset.purchaseConfirmed === "true";


        console.log("memberId:", memberId, "bidId:", bidId);  // 값 확인

        // memberId가 숫자인지 확인하고, 숫자 타입으로 변환
        memberId = Number(memberId);
        bidId = Number(bidId);

        if (purchaseConfirmed) {
          console.log("이미 구매가 확정된 상태입니다.");
          alert("이 물품은 이미 구매가 확정되었습니다.");
          return;
        }

        if (isNaN(memberId) || isNaN(bidId)) {
          alert("유효하지 않은 ID입니다.");
          return;
        }

        // POST 요청을 보낼 때, memberId와 bidId가 Long 타입인지 확인
        $.ajax({
          url: '/bid/confirm-purchase',
          method: 'POST',
          data: {
            memberId: memberId,  // 숫자 형식으로 전달
            bidId: bidId
          },
          beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);  // CSRF 토큰 설정
          },
          success: function(response) {
            console.log('Purchase confirmed!');
            alert("구매가 확정되었습니다!");
            location.reload();  // 성공 시 페이지 새로고침 (다시 낙찰 내역 페이지로 이동)
          },
          error: function(xhr, status, error) {
            console.error('Error:', error);

            // 서버로부터 오류 메시지가 온 경우 처리
            var errorMessage = xhr.responseText;  // 서버에서 보낸 오류 메시지
            if (errorMessage.includes("잔액이 부족합니다.")) {
              // 잔액 부족 메시지가 포함되어 있으면 캐시조회 페이지로 리다이렉트
              alert("잔액이 부족합니다. 캐시조회로 돌아갑니다.");
              window.location.href = "/cash-summary/balance";
            } else {
              alert("오류가 발생했습니다: " + errorMessage);
            }
          }
        });
      });
    });
  </script>
</th:block>


<body>
<div layout:fragment="content">
  <div class="container">
    <ul class="subMenu">
      <li><button type="button" class="tab"><a th:href="@{'/myInfo/update/' + ${memberId}}"> 내정보 </a></button></li>
      <li><button type="button" class="tab"><a th:href="@{/myRent}"> 렌탈중 </a></button></li>
      <li><button type="button" class="tab"> <a th:href="@{'/bid/my-bids/' + ${memberId}}"> 응찰내역 </a></button></li>
      <li><button type="button" class="tab active"><a th:href="@{'/bid/success/' + ${memberId}}"> 낙찰내역 </a></button></li>
      <li><button type="button" class="tab"><a href="/cash-summary/balance"> 캐시조회 </a></button></li>
    </ul>
    <input type="hidden" name="memberId" th:value="${memberId}"/>
    <h3>낙찰 내역</h3>
    <table border="1">
      <thead>
      <tr>
        <th>경매 물품</th>
        <th>작품명</th>
        <th>작가명</th>
        <th>낙찰가</th>
        <th>구매 확정</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="bid : ${bids}">
        <td><img th:src="${bid.artItem.imgUrl}" style="width: 100px; height: 100px;"></td> <!-- 이미지 URL -->
        <td th:text="${bid.artItem.artName}">작품명</td> <!-- 작품명 -->
        <td th:text="${bid.artItem.artistName}">작가명</td> <!-- 작가명 -->
        <td th:text="${bid.bidAmount}">낙찰가</td> <!-- 낙찰가 -->
        <td>
          <!-- 구매 확정 버튼 -->
          <button type="button" class="button confirm-purchase-btn"
                  th:data-member-id="${memberId}"
                  th:data-bid-id="${bid.id}"
                  th:data-purchase-confirmed="${bid.purchaseConfirmed ? 'true' : 'false'}"
                  th:text="${bid.purchaseConfirmed ? '확인 완료' : '구매 확정'}"
                  th:classappend="${bid.purchaseConfirmed ? 'confirmed' : 'pending'}">
          </button>
        </td>
      </tr>
      </tbody>
    </table>
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
  </div>
</div>
</body>
</html>
